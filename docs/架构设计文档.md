# ESP-NOW 无线双子星敏捷锥架构设计文档

## 1. 项目概述

### 1.1 项目名称
ESP-NOW 无线双子星敏捷锥 (Wireless Gemini Agility Cones)

### 1.2 核心理念
系统由两个完全相同的、功能对等的智能敏捷锥组成，通过ESP-NOW进行超低延迟的直接通信，支持动态角色切换，实现丰富的互动训练模式。

### 1.3 开发平台
- **开发环境**: PlatformIO
- **IDE**: Visual Studio Code + PlatformIO Extension
- **框架**: Arduino Framework for ESP32

## 2. 系统架构

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────────────┐
│                    ESP-NOW 无线双子星敏捷锥系统                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐          ESP-NOW         ┌─────────────────┐  │
│  │   敏捷锥 A       │ <-------------------->  │   敏捷锥 B       │  │
│  │  (Master/Slave) │     超低延迟通信          │  (Slave/Master) │  │
│  └─────────────────┘                         └─────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 硬件架构

#### 2.2.1 核心控制器
- **主控芯片**: ESP32-C3-MINI
  - 集成WiFi和蓝牙功能
  - 支持ESP-NOW协议
  - 低功耗设计
  - 丰富的GPIO接口

#### 2.2.2 传感器模块
- **触发器**: 磁感应触发器 (干簧管 + 磁铁)
  - 高可靠性触发
  - 防误触设计
  - 快速响应 (<1ms)

#### 2.2.3 输出设备
- **视觉反馈**: WS2812B RGB LED灯环
  - 可编程全彩显示
  - 支持动态效果
  - 低功耗设计
  - 计时提醒色彩变换
- **音频反馈**: 无源蜂鸣器
  - 提供声音提示
  - 可编程音调
  - 达标提醒音效
- **显示屏**: 128x64 OLED显示屏
  - 实时显示训练数据
  - 状态信息显示
  - 用户界面交互
  - 计时提醒显示

#### 2.2.4 电源系统
- **电池**: 3.7V 锂电池 (1000mAh)
- **充电模块**: TP4056 充电管理
- **电源开关**: 机械开关
- **电源管理**: 低功耗模式支持

#### 2.2.5 结构设计
- **外壳**: 3D打印坚固外壳
- **防护等级**: IP65 (防尘防水)
- **材质**: ABS/PLA 塑料

### 2.3 软件架构

#### 2.3.1 分层架构
```
┌─────────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                    │
├─────────────────────────────────────────────────────────────────┤
│  训练逻辑  │  UI管理  │  LED控制  │  蜂鸣器控制  │  OLED显示       │
├─────────────────────────────────────────────────────────────────┤
│                    业务层 (Business Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  状态管理  │  角色切换  │  计时器   │  数据处理   │  配置管理       │
├─────────────────────────────────────────────────────────────────┤
│                    通信层 (Communication Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│  ESP-NOW协议  │  消息队列  │  数据封装  │  错误处理  │  重传机制    │
├─────────────────────────────────────────────────────────────────┤
│                    硬件抽象层 (HAL Layer)                         │
├─────────────────────────────────────────────────────────────────┤
│  GPIO驱动  │  I2C驱动  │  SPI驱动  │  ADC驱动  │  PWM驱动        │
├─────────────────────────────────────────────────────────────────┤
│                    ESP32-C3 硬件层                               │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.3.2 核心组件

##### 通信管理器 (Communication Manager)
- ESP-NOW初始化和配置
- 消息发送和接收
- 连接状态管理
- 错误处理和重传

##### 状态机 (State Machine)
- 设备状态管理
- 角色切换逻辑
- 训练流程控制
- 异常处理

##### 硬件驱动层 (Hardware Driver Layer)
- LED驱动 (WS2812B)
- OLED驱动 (SSD1306)
- 蜂鸣器驱动
- 传感器驱动

##### 用户界面管理 (UI Manager)
- OLED显示管理
- 菜单系统
- 用户交互处理
- 数据可视化

##### 计时提醒管理 (Timer Alert Manager)
- 训练时长监控
- 达标时长设置
- LED色彩变换控制
- 蜂鸣器提醒音效
- OLED提醒显示

## 3. PlatformIO项目配置

### 3.1 项目结构
```
WirelessGeminiAgilityCones/
├── platformio.ini           # PlatformIO配置文件
├── src/                     # 源代码目录
│   ├── main.cpp            # 主程序入口
│   ├── communication/      # 通信模块
│   ├── hardware/           # 硬件驱动
│   ├── ui/                 # 用户界面
│   └── config/             # 配置文件
├── lib/                    # 本地库
├── include/                # 头文件
├── test/                   # 测试代码
└── docs/                   # 文档
```

### 3.2 PlatformIO配置 (platformio.ini)
```ini
[env:esp32-c3-devkitm-1]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino

# 编译选项
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=1

# 库依赖
lib_deps = 
    adafruit/Adafruit GFX Library@^1.11.3
    adafruit/Adafruit SSD1306@^2.5.7
    fastled/FastLED@^3.5.0
    bblanchon/ArduinoJson@^6.21.2

# 串口监视器配置
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

# 上传配置
upload_protocol = esptool
upload_speed = 921600
```

### 3.3 核心依赖库
- **FastLED**: WS2812B LED控制
- **Adafruit SSD1306**: OLED显示驱动
- **ArduinoJson**: JSON数据处理
- **ESP32 Arduino Core**: ESP32基础功能

## 4. 通信协议设计

### 4.1 ESP-NOW配置
```cpp
// MAC地址定义
#define DEVICE_A_MAC {0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x01}
#define DEVICE_B_MAC {0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x02}

// 通信信道
#define ESPNOW_CHANNEL 1
#define ESPNOW_ENCRYPT false
```

### 4.2 消息结构定义
```cpp
typedef struct {
    uint8_t command;        // 指令类型
    uint8_t target_id;      // 目标设备ID
    uint8_t source_id;      // 源设备ID
    uint32_t timestamp;     // 时间戳
    uint32_t data;          // 数据载荷
    uint8_t checksum;       // 校验和
} message_t;
```

### 4.3 指令类型定义
```cpp
enum CommandType {
    CMD_INIT = 0x01,        // 初始化
    CMD_START_TASK = 0x02,  // 开始任务
    CMD_TASK_COMPLETE = 0x03, // 任务完成
    CMD_RESET = 0x04,       // 重置
    CMD_ROLE_SWITCH = 0x05, // 角色切换
    CMD_HEARTBEAT = 0x06,   // 心跳
    CMD_ERROR = 0xFF        // 错误
};
```

## 5. 状态机设计

### 5.1 设备状态
```cpp
enum DeviceState {
    STATE_INIT,             // 初始化
    STATE_IDLE,             // 空闲
    STATE_READY,            // 准备
    STATE_WAITING,          // 等待
    STATE_ACTIVE,           // 活动
    STATE_COMPLETE,         // 完成
    STATE_ERROR             // 错误
};
```

### 5.2 角色定义
```cpp
enum DeviceRole {
    ROLE_MASTER,            // 主设备
    ROLE_SLAVE,             // 从设备
    ROLE_UNDEFINED          // 未定义
};
```

## 6. 性能指标

### 6.1 通信性能
- **延迟**: <10ms
- **通信距离**: 50-100米 (开阔环境)
- **成功率**: >99%
- **功耗**: <100mA (活动状态)

### 6.2 响应性能
- **触发响应**: <1ms
- **LED响应**: <5ms
- **显示更新**: <50ms
- **音频延迟**: <10ms

### 6.3 电源性能
- **工作电流**: 50-200mA
- **待机电流**: <10mA
- **续航时间**: >8小时
- **充电时间**: 2-3小时

## 7. 可靠性设计

### 7.1 硬件可靠性
- **ESD保护**: 静电保护电路
- **过压保护**: 电源过压保护
- **温度保护**: 工作温度监控
- **防水设计**: IP65防护等级

### 7.2 软件可靠性
- **看门狗**: 系统复位保护
- **异常处理**: 全面的错误处理
- **状态恢复**: 掉电状态保存
- **通信重传**: 消息确认机制

## 8. 扩展性设计

### 8.1 硬件扩展
- **传感器接口**: 预留GPIO接口
- **通信接口**: 支持多种通信方式
- **电源接口**: 支持外部电源
- **调试接口**: UART/JTAG调试

### 8.2 软件扩展
- **模块化设计**: 松耦合架构
- **配置系统**: 灵活的参数配置
- **插件机制**: 支持功能扩展
- **OTA升级**: 无线固件更新

## 9. 开发流程

### 9.1 开发阶段
1. **需求分析**: 功能需求确定
2. **架构设计**: 系统架构设计
3. **硬件设计**: 电路设计和PCB布局
4. **软件开发**: 固件开发和调试
5. **集成测试**: 系统集成测试
6. **现场测试**: 实际环境测试

### 9.2 测试策略
- **单元测试**: 模块功能测试
- **集成测试**: 系统集成测试
- **性能测试**: 性能指标验证
- **可靠性测试**: 长期稳定性测试
- **用户测试**: 用户体验测试

## 10. 总结

本架构设计采用模块化、分层的设计理念，基于PlatformIO平台开发，确保了系统的可维护性、可扩展性和可靠性。通过ESP-NOW协议实现了高效的设备间通信，结合丰富的硬件接口和用户界面，为折返跑训练提供了完整的解决方案。
