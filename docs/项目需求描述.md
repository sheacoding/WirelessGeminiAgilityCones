### **方案：ESP-NOW 无线双子星敏捷锥 (Wireless Gemini Agility Cones)**

**核心理念：** 系统由两个完全相同的、功能对等的智能敏捷锥组成。它们通过ESP-NOW进行超低延迟的直接通信，一个作为“发令员（Master）”，另一个作为“响应者（Slave）”，角色可以在训练中动态切换，实现丰富的互动训练模式。

**ESP-NOW技术优势：**
*   **无需路由器/网络：** 设备之间直接通信，像对讲机一样，开机即用。
*   **超低延迟：** 通信延迟通常在毫秒级，对于反应速度训练来说完全足够。
*   **连接简单：** 无需复杂的配对、连接过程，代码中指定对方的MAC地址即可。
*   **功耗较低：** 比Wi-Fi连接模式省电得多。
*   **可靠性高：** 自带发送状态回调函数，能知道消息是否成功送达。

---

**系统构成 (制作两个完全一样的设备):**

1.  **硬件清单 (每套):**
    *   **主控：** **ESP32-C3-MINI**。
    *   **触发器 (高可靠选择):** 推荐使用 **磁感应 (干簧管+磁铁)** 或 **光遮断** 结构。这是保证触发可靠性的关键。为简化，这里以**磁感应**为例。
    *   **反馈：** **WS2812B RGB LED灯环** 和一个 **无源蜂鸣器**。
    *   **电源：** 3.7V锂电池 + TP4056充电模块 + 开关。
    *   **结构：** 3D打印的坚固外壳，内置磁感应触发结构。

2.  **软件设计与工作流程：**

**第一步：角色定义与初始化 (`setup()`部分)**
*   两个板子烧录**完全相同**的代码。
*   在代码中，预先定义好两个板子的MAC地址，例如：
    ```cpp
    uint8_t peerAddressA[] = {0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x01};
    uint8_t peerAddressB[] = {0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x02};
    ```
*   程序启动时，通过 `WiFi.macAddress()` 获取自身的MAC地址。
*   根据自身的MAC地址，判断自己是A锥还是B锥，并确定对方（Peer）的MAC地址。
*   初始化ESP-NOW，注册发送和接收回调函数。

**第二步：通信协议设计 (数据结构)**
*   为了通信，需要定义一个简单的数据结构。
    ```cpp
    typedef struct struct_message {
      int command;      // 指令类型 (e.g., 1=START_TASK, 2=TASK_COMPLETE, 3=RESET)
      int target_id;    // 目标ID (0=A, 1=B)
      long data;        // 附加数据 (e.g., 反应时间)
    } struct_message;
    ```

**第三步：训练逻辑 (`loop()`与回调函数)**

我们来模拟一次完整的折返跑训练：

1.  **准备阶段：**
    *   两个锥体都开机。它们都处于待机状态，灯环显示白色或熄灭。
    *   我们指定A锥为本次训练的起始点和“主考官”。

2.  **开始训练 (在A锥上操作):**
    *   用户按下A锥上的一个“开始”按钮（或者通过拍打A锥来启动）。
    *   A锥的程序逻辑：
        *   **自身变化：** 灯环变为**蓝色**（表示“这是起点，等待出发”）。
        *   **发送指令：** 创建一个指令包 `msg`，`msg.command = START_TASK;` `msg.target_id = 1;` (目标是B锥)。
        *   通过 `esp_now_send()` 将指令发给B锥。

3.  **B锥接收指令并行动：**
    *   B锥的 **接收回调函数 (`OnDataRecv`)** 被触发，收到了来自A锥的指令。
    *   B锥的程序逻辑：
        *   解析指令，发现是`START_TASK`，目标是自己。
        *   **自身变化：** 灯环立刻变为**红色**（表示“我是目标，快来拍我！”）。
        *   启动自己内部的计时器（`millis()`）。

4.  **用户行动：**
    *   训练者看到A锥变蓝后，从A出发，跑向亮红灯的B锥。
    *   到达后，踩下或拍打B锥。

5.  **B锥被触发，上报结果：**
    *   B锥的磁感应开关被触发。
    *   B锥的程序逻辑：
        *   停止计时器，计算出反应时间 `reaction_time`。
        *   **自身变化：** 灯环变为**绿色**（表示“本次成功！”）。
        *   **发送结果：** 创建一个指令包 `msg`，`msg.command = TASK_COMPLETE;` `msg.target_id = 0;` (目标是A锥)，`msg.data = reaction_time;`。
        *   通过 `esp_now_send()` 将结果发回给A锥。

6.  **A锥接收结果，完成一轮：**
    *   A锥的**接收回调函数**被触发，收到了B锥的完成信号。
    *   A锥的程序逻辑：
        *   解析指令，获取到B锥的完成时间和数据。
        *   可以在A锥上外接一个OLED屏，**显示刚才的用时**。
        *   **自身变化：** 灯环也变为绿色，蜂鸣器“滴”一声，表示一轮折返跑完成。
        *   **准备下一轮：** 短暂延迟后，A锥可以再次发送`START_TASK`指令给B锥，或者将角色互换，由B锥发指令给A锥，实现真正的“折返跑”。

---

**这个方案的突出优点：**

*   **高可靠性：** 结合了物理上可靠的触发器（磁感应/光遮断）和通信上可靠的ESP-NOW协议。
*   **真无线，部署灵活：** 没有线缆束缚，可以放置在任意距离（ESP-NOW在开阔地带可达百米），场地适应性极强。
*   **逻辑清晰，易于编程：** 相对于复杂的网络协议，ESP-NOW的“发消息-收消息”模型非常直观，学生更容易理解和实现。代码量不大。
*   **互动性强，可扩展：** 很容易扩展出更多玩法：
    *   **“打地鼠”模式：** 两个锥随机亮灯，比拼谁先拍到。
    *   **“协作模式”：** 需要两人同时拍下两个锥才能成功。
    *   **增加更多节点：** ESP-NOW支持一对多，可以轻松扩展到3-4个锥体进行更复杂的训练。
*   **成本可控：** 相比每个节点都用蓝牙Mesh，ESP-NOW方案在软件层面更轻量。硬件成本主要在ESP32和传感器上，但因数量少，总体可接受。

**结论：**
**ESP-NOW双主板方案是实现这个项目的“黄金方案”。** 它在可靠性、成本、功能性和开发难度之间取得了完美的平衡。它既能保证作品在现场演示时万无一失，又能充分展现学生对现代无线通信技术的掌握，技术含量和完成度都非常高，是冲击奖项的绝佳选择。